<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace = "com.hgb.gssbe.order.dao.OrderDao">

    <resultMap id="orderDetailMap" type="com.hgb.gssbe.order.model.OrderDetail">
        <result column="ORDER_ID" property="orderId" javaType="string"/>
        <result column="ORDER_ORG_ID" property="orgId" javaType="string"/>
        <result column="ORG_NAME" property="orgName" javaType="string"/>
        <result column="ORDER_ORDERING_DATE" property="orderOrderingDate" javaType="string"/>
        <result column="ORDER_DEAD_LINE_DATE" property="orderDeadLineDate" javaType="string"/>
        <collection property="productList" ofType="com.hgb.gssbe.order.model.OrderProductRes">
            <result column="PRODUCT_ID" property="productId"/>
            <result column="PRODUCT_STYLE_NO" property="productStyleNo" />
            <result column="PRODUCT_ITEM" property="productItem" javaType="string"/>
            <result column="PRODUCT_SIZE" property="productSize" javaType="string"/>
            <result column="PRODUCT_COLOR" property="productColor" javaType="string"/>
            <result column="PRODUCT_QTY" property="productQty" javaType="string"/>
            <result column="PRODUCT_PRICE" property="productPrice" javaType="string"/>
            <result column="PRODUCT_ETC" property="productEtc" javaType="string"/>
        </collection>
    </resultMap>

    <select id = "selectOrders" resultType="com.hgb.gssbe.order.model.OrderRes"
            parameterType="com.hgb.gssbe.order.model.OrderReq">
        SELECT
            TOR.ORDER_ID
            , TOR.ORDER_ORDERING_DATE
            , TON.ORG_NAME
            , GROUP_CONCAT(DISTINCT TPT.PRODUCT_STYLE_NO ORDER BY TPT.PRODUCT_STYLE_NO SEPARATOR ', ') ORDER_STYLE_NOS
        FROM
            TB_ORDER TOR
                LEFT JOIN TB_PRODUCT TPT
                          ON TOR.ORDER_ID  = TPT.ORDER_ID
                LEFT JOIN TB_ORGANIZATION TON
                          ON TON.ORG_ID = TOR.ORDER_ORG_ID
        GROUP BY TOR.ORDER_ID , TOR.ORDER_ORDERING_DATE , TON.ORG_NAME
    </select>

    <select id ="selectOrdersCount" resultType="java.lang.Integer"
            parameterType="com.hgb.gssbe.order.model.OrderReq">
        SELECT
            COUNT(TOR.ORDER_ID)
        FROM
            TB_ORDER TOR
    </select>

    <select id ="selectDetailOrder" parameterType="java.lang.String" resultMap="orderDetailMap">
        SELECT
            TOR.ORDER_ID ORDER_ID
             , TOR.ORDER_ORG_ID ORDER_ORG_ID
             , ORG.ORG_NAME ORG_NAME
             , TOR.ORDER_ORDERING_DATE ORDER_ORDERING_DATE
             , TOR.ORDER_DEAD_LINE_DATE ORDER_DEAD_LINE_DATE
             , TP.PRODUCT_ID PRODUCT_ID
             , TP.PRODUCT_STYLE_NO PRODUCT_STYLE_NO
             , TP.PRODUCT_ITEM PRODUCT_ITEM
             , TP.PRODUCT_SIZE PRODUCT_SIZE
             , TP.PRODUCT_COLOR PRODUCT_COLOR
             , TP.PRODUCT_QTY PRODUCT_QTY
             , TP.PRODUCT_PRICE PRODUCT_PRICE
             , TP.PRODUCT_ETC PRODUCT_ETC
        FROM
            TB_ORDER TOR
                LEFT JOIN TB_PRODUCT TP
                          ON TP.ORDER_ID = TOR.ORDER_ID
                LEFT JOIN TB_ORGANIZATION ORG
                          ON ORG.ORG_ID = TOR.ORDER_ORG_ID
        WHERE
            TOR.ORDER_ID = #{orderId}
    </select>

    <insert id="insertOrdering" parameterType="com.hgb.gssbe.order.model.Order">
        INSERT INTO TB_ORDER(
                ORDER_ID
                , ORDER_ORG_ID
                , USE_YN
                , ORDER_ORDERING_DATE
                , ORDER_DEAD_LINE_DATE
                , CREATE_DATE
                , CREATE_USER_ID )
        VALUES (
                   #{orderId}
                   , #{orgId}
                   , 'Y'
                   , #{orderOrderingDate}
                   , #{orderDeadLineDate}
                   , NOW()
                   , #{createUserId}
               )
    </insert>

    <insert id="insertOrderProduct" parameterType="com.hgb.gssbe.order.model.OrderProduct">
        INSERT INTO TB_PRODUCT(
                PRODUCT_ID
                , ORDER_ID
                , PRODUCT_STYLE_NO
                , PRODUCT_ITEM
                , PRODUCT_SIZE
                , PRODUCT_COLOR
                , PRODUCT_QTY
                , PRODUCT_PRICE
                , PRODUCT_ETC
                , USE_YN
                , CREATE_DATE
                , CREATE_USER_ID
        )VALUES (
                 #{productId}
                 , #{orderId}
                 , #{productStyleNo}
                 , #{productItem}
                 , #{productSize}
                 , #{productColor}
                 , #{productQty}
                 , #{productPrice}
                 , #{productEtc}
                 , 'Y'
                 , NOW()
                 , #{createUserId}
                )
    </insert>

</mapper>